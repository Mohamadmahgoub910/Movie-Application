@using MovieApp.Core.Entities
@model MovieApp.ViewModels.AnalyticsViewModel
@{
    ViewData["Title"] = "تحليلات الأفلام";
}

<style>
    .stat-card {
        border-radius: 15px;
        padding: 1.5rem;
        color: white;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        transition: transform 0.3s ease;
        margin-bottom: 1.5rem;
    }
    .stat-card:hover { transform: translateY(-5px); }
    .stat-card i { font-size: 2.5rem; opacity: 0.8; }
    .stat-number { font-size: 2rem; font-weight: bold; margin: 0.5rem 0; }
    .card-gradient-1 { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .card-gradient-2 { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
    .card-gradient-3 { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
    .card-gradient-4 { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
    .card-gradient-5 { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
    .card-gradient-6 { background: linear-gradient(135deg, #30cfd0 0%, #330867 100%); }
    .card-gradient-7 { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); }
    .card-gradient-8 { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); }
</style>

<h1 class="mb-4">
    <i class="fas fa-chart-line me-2"></i>
    تحليلات الأفلام - Analytics Dashboard
</h1>

<!-- Main Statistics -->
<div class="row">
    <div class="col-lg-3 col-md-6">
        <div class="stat-card card-gradient-1 text-center">
            <i class="fas fa-film"></i>
            <div class="stat-number">@Model.TotalMovies</div>
            <div>إجمالي الأفلام</div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6">
        <div class="stat-card card-gradient-2 text-center">
            <i class="fas fa-play-circle"></i>
            <div class="stat-number">@Model.NowShowingMovies</div>
            <div>يُعرض الآن</div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6">
        <div class="stat-card card-gradient-3 text-center">
            <i class="fas fa-clock"></i>
            <div class="stat-number">@Model.ComingSoonMovies</div>
            <div>قريباً</div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6">
        <div class="stat-card card-gradient-4 text-center">
            <i class="fas fa-stop-circle"></i>
            <div class="stat-number">@Model.EndedMovies</div>
            <div>انتهى العرض</div>
        </div>
    </div>
</div>

<!-- Revenue Statistics -->
<div class="row">
    <div class="col-lg-3 col-md-6">
        <div class="stat-card card-gradient-5 text-center">
            <i class="fas fa-dollar-sign"></i>
            <div class="stat-number">@Model.TotalRevenue.ToString("N0")</div>
            <div>إجمالي الإيرادات</div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6">
        <div class="stat-card card-gradient-6 text-center">
            <i class="fas fa-chart-bar"></i>
            <div class="stat-number">@Model.AveragePrice.ToString("N0")</div>
            <div>متوسط السعر</div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6">
        <div class="stat-card card-gradient-7 text-center">
            <i class="fas fa-arrow-up"></i>
            <div class="stat-number">@Model.HighestPrice.ToString("N0")</div>
            <div>أعلى سعر</div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6">
        <div class="stat-card card-gradient-8 text-center">
            <i class="fas fa-arrow-down"></i>
            <div class="stat-number">@Model.LowestPrice.ToString("N0")</div>
            <div>أقل سعر</div>
        </div>
    </div>
</div>

<div class="row g-3 mb-3">
    <!-- Movies by Status Chart -->
    <div class="col-lg-4">
        <div class="card h-100">
            <div class="card-header bg-light">
                <h5 class="mb-0">الأفلام حسب الحالة</h5>
            </div>
            <div class="card-body">
                <canvas id="statusChart" height="300"></canvas>
            </div>
        </div>
    </div>

    <!-- Movies by Category Chart -->
    <div class="col-lg-4">
        <div class="card h-100">
            <div class="card-header bg-light">
                <h5 class="mb-0">الأفلام حسب التصنيف</h5>
            </div>
            <div class="card-body">
                <canvas id="categoryChart" height="300"></canvas>
            </div>
        </div>
    </div>

    <!-- Movies by Cinema Chart -->
    <div class="col-lg-4">
        <div class="card h-100">
            <div class="card-header bg-light">
                <h5 class="mb-0">الأفلام حسب السينما</h5>
            </div>
            <div class="card-body">
                <canvas id="cinemaChart" height="300"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Top Movies & Top Actors -->
<div class="row g-3 mb-3">
    <div class="col-lg-6">
        <div class="card h-100">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h5 class="mb-0">أعلى 10 أفلام سعراً</h5>
                <span class="badge bg-primary">@Model.TopMoviesByPrice.Count فيلم</span>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>#</th>
                                <th>اسم الفيلم</th>
                                <th>التصنيف</th>
                                <th>السينما</th>
                                <th class="text-end">السعر</th>
                            </tr>
                        </thead>
                        <tbody>
                            @for (int i = 0; i < Model.TopMoviesByPrice.Count; i++)
                            {
                                var movie = Model.TopMoviesByPrice[i];
                                <tr>
                                    <td><strong>@(i + 1)</strong></td>
                                    <td>
                                        <a asp-controller="Movies" asp-action="Details" asp-route-id="@movie.Id" class="text-decoration-none">
                                            @movie.Name
                                        </a>
                                    </td>
                                    <td><span class="badge bg-info">@movie.Category?.Name</span></td>
                                    <td><small class="text-muted">@movie.Cinema?.Name</small></td>
                                    <td class="text-end"><strong class="text-success">@movie.Price.ToString("C")</strong></td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-6">
        <div class="card h-100">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h5 class="mb-0">أكثر الممثلين مشاركة</h5>
                <span class="badge bg-success">@Model.TopActors.Count ممثل</span>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>#</th>
                                <th>الممثل</th>
                                <th class="text-end">عدد الأفلام</th>
                            </tr>
                        </thead>
                        <tbody>
                            @for (int i = 0; i < Model.TopActors.Count; i++)
                            {
                                var actor = Model.TopActors[i];
                                <tr>
                                    <td><strong>@(i + 1)</strong></td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            @if (!string.IsNullOrEmpty(actor.ProfilePicture))
                                            {
                                                <img src="@actor.ProfilePicture" class="rounded-circle me-2" width="35" height="35" style="object-fit: cover;" />
                                            }
                                            else
                                            {
                                                <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center me-2" style="width: 35px; height: 35px;">
                                                    <i class="fas fa-user"></i>
                                                </div>
                                            }
                                            <span>@actor.ActorName</span>
                                        </div>
                                    </td>
                                    <td class="text-end"><span class="badge bg-primary rounded-pill">@actor.MovieCount</span></td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- All Movies Table -->
<div class="card">
    <div class="card-header bg-light d-flex justify-content-between align-items-center">
        <h5 class="mb-0">جميع الأفلام</h5>
        <div>
            <a asp-controller="Movies" asp-action="Create" class="btn btn-primary btn-sm">
                <i class="fas fa-plus me-1"></i>إضافة فيلم
            </a>
        </div>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover table-striped mb-0">
                <thead class="table-dark">
                    <tr>
                        <th>#</th>
                        <th>الصورة</th>
                        <th>اسم الفيلم</th>
                        <th>التصنيف</th>
                        <th>السينما</th>
                        <th>الحالة</th>
                        <th>السعر</th>
                        <th>تاريخ العرض</th>
                        <th>الممثلين</th>
                        <th>إجراءات</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var movie in Model.AllMovies)
                    {
                        <tr>
                            <td>@movie.Id</td>
                            <td>
                                <img src="@(string.IsNullOrEmpty(movie.MainImage) ? "/images/placeholder.jpg" : movie.MainImage)"
                                     class="rounded" width="50" height="50" style="object-fit: cover;" />
                            </td>
                            <td><strong>@movie.Name</strong></td>
                            <td><span class="badge bg-info">@movie.Category?.Name</span></td>
                            <td><small>@movie.Cinema?.Name</small></td>
                            <td>
                                <span class="badge @(movie.Status == MovieStatus.NowShowing ? "bg-success" : movie.Status == MovieStatus.ComingSoon ? "bg-warning text-dark" : "bg-secondary")">
                                    @(movie.Status == MovieStatus.NowShowing ? "يُعرض الآن" : movie.Status == MovieStatus.ComingSoon ? "قريباً" : "انتهى")
                                </span>
                            </td>
                            <td><strong class="text-success">@movie.Price.ToString("C")</strong></td>
                            <td><small>@movie.ReleaseDateTime.ToString("dd/MM/yyyy")</small></td>
                            <td>
                                <small class="text-muted">
                                    @if (movie.MovieActors.Any())
                                    {
                                        @string.Join(", ", movie.MovieActors.Take(2).Select(ma => ma.Actor.Name))
                                        @if (movie.MovieActors.Count > 2)
                                        {
                                            <span>...</span>
                                        }
                                    }
                                    else
                                    {
                                        <span>-</span>
                                    }
                                </small>
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <a asp-controller="Movies" asp-action="Details" asp-route-id="@movie.Id"
                                       class="btn btn-outline-primary" title="تفاصيل">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <a asp-controller="Movies" asp-action="Edit" asp-route-id="@movie.Id"
                                       class="btn btn-outline-warning" title="تعديل">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <a asp-controller="Movies" asp-action="Delete" asp-route-id="@movie.Id"
                                       class="btn btn-outline-danger" title="حذف">
                                        <i class="fas fa-trash"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        // Movies by Status Chart
        var statusCtx = document.getElementById('statusChart').getContext('2d');
        new Chart(statusCtx, {
            type: 'doughnut',
            data: {
                labels: [@Html.Raw(string.Join(",", Model.MoviesByStatus.Select(s => $"'{s.StatusName}'")))],
                datasets: [{
                    data: [@string.Join(",", Model.MoviesByStatus.Select(s => s.Count))],
                    backgroundColor: ['#28a745', '#ffc107', '#6c757d']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });

        // Movies by Category Chart
        var categoryCtx = document.getElementById('categoryChart').getContext('2d');
        new Chart(categoryCtx, {
            type: 'pie',
            data: {
                labels: [@Html.Raw(string.Join(",", Model.MoviesByCategory.Select(c => $"'{c.CategoryName}'")))],
                datasets: [{
                    data: [@string.Join(",", Model.MoviesByCategory.Select(c => c.MovieCount))],
                    backgroundColor: ['#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe', '#00f2fe']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });

        // Movies by Cinema Chart
        var cinemaCtx = document.getElementById('cinemaChart').getContext('2d');
        new Chart(cinemaCtx, {
            type: 'bar',
            data: {
                labels: [@Html.Raw(string.Join(",", Model.MoviesByCinema.Select(c => $"'{c.CinemaName}'")))],
                datasets: [{
                    label: 'عدد الأفلام',
                    data: [@string.Join(",", Model.MoviesByCinema.Select(c => c.MovieCount))],
                    backgroundColor: '#667eea'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    </script>
}